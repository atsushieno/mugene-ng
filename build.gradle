allprojects {
    repositories {
        mavenLocal()
        google()
        mavenCentral()
        maven { url "https://jitpack.io" }
        maven {
            url "https://maven.pkg.github.com/atsushieno/ktmidi"
            credentials {
                username = project.findProperty("gpr.user") ?: System.getenv("USERNAME")
                password = project.findProperty("gpr.token") ?: System.getenv("GITHUB_TOKEN")
            }
        }
    }
}

// This is a workaround for https://youtrack.jetbrains.com/issue/KT-44884
configurations.matching { it.name != "kotlinCompilerPluginClasspath" }.all {
    resolutionStrategy.eachDependency {
        version = requested.version
        if (requested.group == "org.jetbrains.kotlinx" &&
                requested.name.startsWith("kotlinx-coroutines") &&
                version != null && !version.contains("native-mt")
        ) {
            useVersion("$version-native-mt")
        }
    }
}

subprojects {
    apply plugin: "maven-publish"

    repositories {
        maven {
            name = "OSSRH"
            url = uri("https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/")
            credentials {
                username = System.getenv("OSSRH_USERNAME")
                password = System.getenv("OSSRH_PASSWORD")
            }
        }
    }
}

apply from: "${rootDir}/publish-root.gradle"
